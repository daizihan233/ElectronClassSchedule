name: Rolling Build & Publish

on:
  push:
    branches:
      - main

jobs:
  build_and_publish:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up VS
        uses: seanmiddleditch/gha-setup-vsdevenv@master

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Rebuild native deps for Electron
        run: npx electron-rebuild

      - name: Compute rolling version and write to package.json
        shell: pwsh
        run: |
          $ym  = Get-Date -Format "yyyyMM"
          $dd  = Get-Date -Format "dd"
          # 语义化版本：YYYYMM.DD.N
          $ver = "$ym.$dd.${{ github.run_number }}"
          Write-Host "Rolling version: $ver"
          $pkgPath = "package.json"
          $pkg = Get-Content $pkgPath -Raw | ConvertFrom-Json
          $pkg.version = $ver
          $pkg | ConvertTo-Json -Depth 100 | Out-File -Encoding UTF8 $pkgPath
          Get-Content $pkgPath

      - name: Build and publish to GitHub Releases (rolling)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx electron-builder --win --x64 --publish always

      - name: Upload dist as artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-windows
          path: |
            dist/**
          if-no-files-found: warn
